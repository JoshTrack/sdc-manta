#!/bin/bash
#
# This Source Code Form is subject to the terms of the Mozilla Public
# License, v. 2.0. If a copy of the MPL was not distributed with this
# file, You can obtain one at http://mozilla.org/MPL/2.0/.
#

#
# Copyright (c) 2014, Joyent, Inc.
#

#
# manta-deploy-svcs: deploy manta data services on a lab system
#

set -o errexit
set -o xtrace

for i in $(seq 1 3); do
	for shard in $(seq 1 2); do
		manta-deploy postgres -z ${shard}
	done
done

for i in $(seq 1 3); do
	for shard in $(seq 1 2); do
		manta-deploy moray -z ${shard}
	done
done

manta-shardadm set -i "1.moray 2.moray"
manta-shardadm set -m "1.moray"
manta-shardadm set -s "1.moray"

set +o errexit
manta-create-topology.sh -v 10000000 -p 2020
ret_code=$?
case "$?" in
	3)
		echo "hash ring already exists"
		;;
	0)
		echo "successfully generated hash ring"
		;;
	*)
		echo "could not generate ring"
		exit 1
esac
set -o errexit

manta-deploy electric-moray

for i in $(seq 1 3); do
	manta-deploy storage
done

for i in $(seq 1 2); do
	manta-deploy authcache
done

for i in $(seq 1 2); do
	manta-deploy webapi
done

for i in $(seq 1 2) ; do
	manta-deploy loadbalancer
done

for i in $(seq 1 2) ; do
	manta-deploy jobsupervisor
done

manta-deploy jobpuller

for i in $(seq 1 2) ; do
	manta-deploy medusa
done

manta-deploy ops
